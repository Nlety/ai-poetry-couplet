const DOM = {};
const AppState = { type: 'couplet', theme: '', style: 'classic', occasion: 'newyear', currentContent: '', works: [] };
function initDOM() { DOM.themeInput = document.getElementById('theme-input'); DOM.style = document.getElementById('style'); DOM.occasion = document.getElementById('occasion'); DOM.occasionWrap = document.getElementById('occasion-wrap'); DOM.btnGenerate = document.getElementById('btn-generate'); DOM.resultArea = document.getElementById('result-area'); DOM.content = document.getElementById('content'); DOM.collectionPanel = document.getElementById('collection-panel'); DOM.collectionList = document.getElementById('collection-list'); DOM.collectionOverlay = document.getElementById('collection-overlay'); DOM.settingsModal = document.getElementById('settings-modal'); DOM.toast = document.getElementById('toast'); }
function initEvents() {
    document.querySelectorAll('.type-btn').forEach(btn => btn.addEventListener('click', () => { document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); AppState.type = btn.dataset.type; DOM.occasionWrap.classList.toggle('hidden', btn.dataset.type !== 'couplet'); }));
    DOM.themeInput.addEventListener('input', () => AppState.theme = DOM.themeInput.value);
    DOM.style.addEventListener('change', () => AppState.style = DOM.style.value);
    DOM.occasion.addEventListener('change', () => AppState.occasion = DOM.occasion.value);
    DOM.btnGenerate.addEventListener('click', generate);
    document.getElementById('btn-save').addEventListener('click', saveWork);
    document.getElementById('btn-collection').addEventListener('click', () => { DOM.collectionPanel.classList.add('open'); DOM.collectionOverlay.classList.remove('hidden'); });
    document.getElementById('btn-close-collection').addEventListener('click', closeCollection); DOM.collectionOverlay.addEventListener('click', closeCollection);
    document.getElementById('btn-settings').addEventListener('click', () => { DOM.settingsModal.classList.add('show'); loadSettings(); });
    document.getElementById('btn-close-settings').addEventListener('click', () => DOM.settingsModal.classList.remove('show'));
    document.getElementById('btn-cancel-settings').addEventListener('click', () => DOM.settingsModal.classList.remove('show'));
    document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
    document.querySelectorAll('.example-btn').forEach(btn => btn.addEventListener('click', () => loadExample(btn.dataset.example)));
}
const EXAMPLES = { spring: { type: 'couplet', theme: 'æ–°å¹´ç¥ç¦ã€ä¸‡äº‹å¦‚æ„', style: 'festive' }, love: { type: 'seven', theme: 'æœˆä¸‹ç›¸æ€', style: 'romantic' }, career: { type: 'couplet', theme: 'äº‹ä¸šæˆåŠŸã€æ­¥æ­¥é«˜å‡', style: 'inspiring' }, acro: { type: 'acrostic', theme: 'å‰ç¨‹ä¼¼é”¦', style: 'classic' } };
function loadExample(key) { const ex = EXAMPLES[key]; if (!ex) return; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.type-btn[data-type="${ex.type}"]`)?.classList.add('active'); AppState.type = ex.type; DOM.themeInput.value = ex.theme; AppState.theme = ex.theme; DOM.style.value = ex.style; AppState.style = ex.style; DOM.occasionWrap.classList.toggle('hidden', ex.type !== 'couplet'); showToast('info', 'å·²å¡«å…¥', 'ç‚¹å‡»ç”Ÿæˆä½œå“'); }
async function generate() { DOM.resultArea.classList.remove('hidden'); DOM.content.innerHTML = ''; AppState.currentContent = ''; await AIService.generate(AppState.type, AppState.theme, AppState.style, AppState.occasion, (t) => { AppState.currentContent += t; DOM.content.innerHTML = formatContent(AppState.currentContent); }, () => showToast('success', 'åˆ›ä½œå®Œæˆ', ''), (e) => showToast('error', 'ç”Ÿæˆå¤±è´¥', e.message)); }
function formatContent(text) { return text.replace(/ä¸Šè”ï¼š(.+)/g, '<div class="text-red-800 mb-2">ğŸ”´ ä¸Šè”ï¼š<span class="font-bold">$1</span></div>').replace(/ä¸‹è”ï¼š(.+)/g, '<div class="text-red-800 mb-2">ğŸ”´ ä¸‹è”ï¼š<span class="font-bold">$1</span></div>').replace(/æ¨ªæ‰¹ï¼š(.+)/g, '<div class="text-amber-700 text-3xl font-bold my-4 border-b-2 border-amber-300 pb-2">ğŸ® æ¨ªæ‰¹ï¼š$1</div>').replace(/ã€(.+?)ã€‘/g, '<span class="text-gray-600 text-base">ã€$1ã€‘</span>').replace(/\n/g, '<br>'); }
async function saveWork() { if (!AppState.currentContent) { showToast('warning', 'æ— å†…å®¹', ''); return; } const typeLabels = { couplet: 'å¯¹è”', acrostic: 'è—å¤´è¯—', seven: 'ä¸ƒè¨€è¯—', five: 'äº”è¨€è¯—', ci: 'å®‹è¯' }; const work = { type: AppState.type, typeLabel: typeLabels[AppState.type], theme: AppState.theme, content: AppState.currentContent }; const result = await StorageService.saveWork(work); if (result.success) { showToast('success', 'å·²æ”¶è—', ''); loadCollection(); } }
async function loadCollection() { AppState.works = await StorageService.getWorks(); renderCollection(); }
function renderCollection() { if (AppState.works.length === 0) { DOM.collectionList.innerHTML = '<p class="text-gray-400 text-sm text-center">æš‚æ— æ”¶è—</p>'; return; } DOM.collectionList.innerHTML = AppState.works.map(w => `<div class="p-3 bg-red-50 rounded-xl"><div class="font-medium text-red-700">ğŸ“œ ${w.typeLabel}</div><div class="text-sm text-gray-600 mt-1 truncate">${w.theme || ''}</div><div class="text-xs text-gray-400 mt-1">${new Date(w.createdAt).toLocaleDateString()}</div></div>`).join(''); }
function closeCollection() { DOM.collectionPanel.classList.remove('open'); DOM.collectionOverlay.classList.add('hidden'); }
function loadSettings() { const c = AIService.getModelConfig() || {}; document.getElementById('api-url').value = c.apiUrl || ''; document.getElementById('api-key').value = c.apiKey || ''; document.getElementById('model-name').value = c.modelName || ''; }
function saveSettings() { const c = { apiUrl: document.getElementById('api-url').value.trim(), apiKey: document.getElementById('api-key').value.trim(), modelName: document.getElementById('model-name').value.trim() || 'GLM-4-Flash' }; if (!c.apiUrl || !c.apiKey) { showToast('warning', 'è¯·å¡«å†™å®Œæ•´', ''); return; } AIService.saveModelConfig(c); DOM.settingsModal.classList.remove('show'); showToast('success', 'é…ç½®å·²ä¿å­˜', ''); }
function showToast(type, title, message) { const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' }; const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-red-500' }; document.getElementById('toast-icon').className = `w-8 h-8 rounded-full flex items-center justify-center ${colors[type]}`; document.getElementById('toast-icon').textContent = icons[type]; document.getElementById('toast-title').textContent = title; document.getElementById('toast-message').textContent = message; DOM.toast.classList.remove('hidden'); setTimeout(() => DOM.toast.classList.add('hidden'), 3000); }
async function init() { initDOM(); initEvents(); await loadCollection(); const config = await AIService.initConfig(); if (!config) setTimeout(() => { DOM.settingsModal.classList.add('show'); showToast('info', 'æ¬¢è¿ä½¿ç”¨', 'è¯·é…ç½® AI æ¨¡å‹'); }, 500); }
document.addEventListener('DOMContentLoaded', init);
